---
import { getCollection, render } from "astro:content";
import DocumentLayout from "../../layouts/document.astro";
import { categoryColours } from "../../lib/colours";
import GithubSlugger from "github-slugger";

interface TocEntry {
  depth: number;
  text: string;
  id: string;
}

function extractToc(markdown: string): TocEntry[] {
  const slugger = new GithubSlugger();

  // Strip fenced and indented code blocks to avoid matching headings inside them
  const stripped = markdown
    .replace(/```[\s\S]*?```/g, "")
    .replace(/^(?: {4}|\t).+$/gm, "");

  // Match ALL headings to keep slugger counter in sync with rehype-slug
  const headingRegex = /^(#{1,6})\s+(.+)$/gm;
  const entries: TocEntry[] = [];
  let match;

  while ((match = headingRegex.exec(stripped)) !== null) {
    const depth = match[1].length;
    const raw = match[2]
      .replace(/\*{1,3}([^*]+)\*{1,3}/g, "$1")
      .replace(/`([^`]+)`/g, "$1")
      .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1")
      .trim();
    const id = slugger.slug(raw);

    // Only include H2 and H3 in the displayed TOC
    if (depth === 2 || depth === 3) {
      entries.push({ depth, text: raw, id });
    }
  }

  return entries;
}

export async function getStaticPaths() {
  const entries = await getCollection("designDocs");
  return entries.map((entry) => ({
    params: { slug: entry.data.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);
const toc = extractToc(entry.body ?? "");
const colour = categoryColours[entry.data.category] ?? "#888888";

const allReviews = await getCollection("documentReviews");
const docReviews = allReviews.filter((r) => r.id.split("/")[0] === entry.data.slug);
const reviewCount = docReviews.length;
const rating = reviewCount > 0
  ? Math.round((docReviews.reduce((sum, r) => sum + r.data.rating, 0) / reviewCount) * 10) / 10
  : null;
---

<DocumentLayout
  title={entry.data.title}
  description={entry.data.description}
  category={entry.data.category}
  format={entry.data.format}
  date={entry.data.date}
  status={entry.data.status}
  slug={entry.data.slug}
  tags={entry.data.tags ?? []}
  details={entry.data.details ?? []}
  toc={toc}
  colour={colour}
  rating={rating}
  reviewCount={reviewCount}
>
  <Content />
</DocumentLayout>
